language: go

go:
- 1.7
- tip

cache:
  directories:
  - ~/.platformio

addons:
  apt:
    packages:
    - libi2c-dev
    - gcc-arm-linux-gnueabi
    - libc6-dev-armel-cross
    # shellcheck is not in Travis' Ubuntu
    #- shellcheck

install:
- pip install --user --upgrade platformio
- platformio lib install 19 580 # Adafruit-DHT, EasyVR
- platformio lib update

script:
# Raspberry Pi part
- eval "$(curl https://raw.githubusercontent.com/dasfoo/travis/master/install-protoc.sh)"
- curl https://raw.githubusercontent.com/dasfoo/travis/master/go.sh | sh
# Common arduino part
- curl https://raw.githubusercontent.com/dasfoo/travis/master/cpp.sh | sh -s bb/* mc/*
- export PLATFORMIO_BUILD_FLAGS="-Wall -Werror"
# BotBoarduino part
- platformio ci --board=diecimilaatmega328 bb
# MotorController part
- platformio ci --board=diecimilaatmega328 mc
# Shell part
- curl https://raw.githubusercontent.com/dasfoo/travis/master/shell.sh | sh -s bin/*
- |
    set -a
    eval "$(bin/deploy env)"
    go build

    echo "${REMOTE_HOST_KEY?}" >>$HOME/.ssh/known_hosts
    eval "$(ssh-agent)"
    ssh-add <(sed 's/|/\n/g' <<<"${REMOTE_HOST_LOGIN_KEY?}")

    scp -P 31438 -r ./rover "${REMOTE_HOST?}":/tmp/

before_deploy:
# Generate deploy script
- |
    cat >travis-deploy.sh <<'SHELL'
    set -e
    if [ "${TRAVIS_GO_VERSION?}" != "tip" ]; then
      echo "${REMOTE_HOST_KEY?}" >>$HOME/.ssh/known_hosts
      eval "$(ssh-agent)"
      ssh-add <(sed 's/|/\n/g' <<<"${REMOTE_HOST_LOGIN_KEY?}")
      tar -C "${GOPATH?}" -czf - src |
      ssh -q "${REMOTE_HOST?}" "
          rm -rf \$GOPATH/src &&
          mkdir -p \$GOPATH &&
          tar -xzf - -C \$GOPATH &&
          \$GOPATH/src/github.com/${TRAVIS_REPO_SLUG?}/bin/deploy push
        "
    else
        echo "Not deploying for Go tip build."
    fi

deploy:
  provider: script
  skip_cleanup: true
  script: bash travis-deploy.sh

branches:
  only:
  - master
