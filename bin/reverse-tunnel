#!/usr/bin/env bash

# Reverse port-forwarding (using ssh for now).
# systemd is supposed to take care of restarting this on failure.

set -e

: "${1?remote side in form host:port or user@host:port required}"

REMOTE_PORT="${1##*:}"
SSH_TARGET="${1%:*}"
REMOTE_INTERFACE=127.0.0.1
if [ "${REMOTE_PORT?}" != "${REMOTE_PORT%_}" ]; then
	REMOTE_INTERFACE=0.0.0.0
	REMOTE_PORT="${REMOTE_PORT%_}"
fi

LOCAL_PORT="${LOCAL_PORT:-${REMOTE_PORT}}"

# The script is not supposed to ssh as root, and unprivileged users normally
# don't have permissions to listen on lower ports. We're adding a magic number
# since it's a Raspberry Pi project, and Pi ~= 3.1416.
[ "${REMOTE_PORT?}" -lt 1024 ] &&
	let 'REMOTE_PORT=REMOTE_PORT+31416'

# https://github.com/koalaman/shellcheck/issues/327
# shellcheck disable=SC2029
exec ssh -vvv \
	-o 'ExitOnForwardFailure yes' \
	-o 'ServerAliveInterval 30' \
	-o 'ConnectTimeout 5' \
	-o 'BatchMode yes' \
	-N -R \
	"${REMOTE_INTERFACE?}:${REMOTE_PORT?}:localhost:${LOCAL_PORT?}" \
	"${SSH_TARGET?}"
