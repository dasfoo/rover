#!/usr/bin/env bash

set -e

: ${1?no package name provided}

local_binary=$(mktemp --tmpdir -- "build-upload.$(basename $1).XXXXXXXXX")
trap 'rm -f "$local_binary"' EXIT

repo=$(basename $(git rev-parse --show-toplevel))
remote_binary="$repo/$(basename "$1" .go).$USER"

echo "[1/3] Building ${remote_binary}..."
# TODO: use arm-linux-gnueabihf-gcc (note the 'hf'), take CGO_CFLAGS flags from
# $ gcc -mcpu=native -march=native -Q --help=target
# Currently it's '-march=armv6zk -mcpu=arm1176jz-s -mfloat-abi=hard -mfpu=vfp'
# but dies randomly with SIGSEGV or SIGILL.
CGO_ENABLED=1 CC=arm-linux-gnueabi-gcc \
	GOOS=linux GOARCH=arm go build -o "$local_binary" "$1"
shift

echo "[2/3] Copying $remote_binary..."
gzip -c "$local_binary" | sudo -u pi -- ssh pi "
	gzip -d >$remote_binary &&
	chmod +x $remote_binary &&
	echo '[3/3] Starting ${remote_binary}...' &&
	$remote_binary $@
	exit # somehow necessary to see an error message (e.g. killed by SEGV)
"
